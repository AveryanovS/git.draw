<html>

<head>
    <title>Git draw</title>
</head>

<body>
    <style>
        button, input {
            display: block;
            margin: 20px;
        }
    </style>
    <svg width="828" height="128" class="js-calendar-graph-svg">
        <g id="root" transform="translate(10, 20)">
            <g id="column" transform="translate(0, 0)">
                <rect width="12" height="12" x="16" y="0" fill="#ebedf0"></rect>
                <rect width="12" height="12" x="16" y="15" fill="#ebedf0"></rect>
                <rect width="12" height="12" x="16" y="30" fill="#ebedf0"></rect>
                <rect width="12" height="12" x="16" y="45" fill="#ebedf0"></rect>
                <rect width="12" height="12" x="16" y="60" fill="#ebedf0"></rect>
                <rect width="12" height="12" x="16" y="75" fill="#ebedf0"></rect>
                <rect width="12" height="12" x="16" y="90" fill="#ebedf0"></rect>
            </g>
        </g>
    </svg>
    <input id="repo" type="text" placeholder="Git repo url">
    <button id="save" >Save</button>
    <script>
        const colors = ['#ebedf0', '#c6e48b', '#7bc96f', '#239a3b', '#196127'];
        const root = document.getElementById('root');
        const column = document.getElementById('column');
        const save = document.getElementById('save');
        const repo = document.getElementById('repo');
        
        for(let i = 16; i < 320; i += 16){
            const clone =  column.cloneNode(true);
            clone.setAttribute('transform', `translate(${i}, 0)`);
            root.appendChild(clone);
        }


        const rects = document.getElementsByTagName('rect');
        for (const rect of rects)
            rect.onclick = function () {
                const color = rect.getAttribute('fill');
                const index = colors.indexOf(color);
                rect.setAttribute('fill', colors[index + 1] || colors[0]);
            };

        save.onclick = function () {
            const date = new Date();
            date.setDate(date.getDate() + (7 - date.getDay())); // Nearest sunday
            const commits = [];
            for(const rect of rects)
                commits.push(
                    colors.indexOf(rect.getAttribute('fill')) * 5
                );
            const data = {
                repo: repo.value,
                date,
                commits
            };
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(data));

            xhr.onreadystatechange = function() {
                if (xhr.readyState != 4) return;

                save.innerHTML = 'Save';
                save.disabled = false;

                if (xhr.status != 200) {
                    alert('Error');
                    
                } else {
                    alert('Done');
                }

            }
            save.innerHTML = 'Loading...';
            save.disabled = true;
        };
            
        
    </script>
</body>

</html>
